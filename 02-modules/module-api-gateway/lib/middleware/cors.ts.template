/**
 * ================================================================
 * AI Web App Template - CORSä¸­é–“ä»¶ (lib/middleware/cors.ts)
 * ================================================================
 *
 * ã€æª”æ¡ˆåŠŸèƒ½ã€‘
 * å¯¦ç¾è·¨åŸŸè³‡æºå…±äº«(CORS)ç­–ç•¥ï¼Œæ”¯æ´å‹•æ…‹é…ç½®å’Œé æª¢è«‹æ±‚è™•ç†ã€‚
 * æä¾›éˆæ´»çš„CORSæ§åˆ¶ï¼Œé©æ‡‰ä¸åŒç’°å¢ƒå’Œç«¯é»çš„éœ€æ±‚ã€‚
 *
 * ã€ä¸»è¦è·è²¬ã€‘
 * â€¢ CORSé ­éƒ¨è¨­ç½® - å‹•æ…‹é…ç½®Access-Control-*é ­éƒ¨
 * â€¢ é æª¢è«‹æ±‚è™•ç† - OPTIONSè«‹æ±‚çš„é«˜æ•ˆè™•ç†
 * â€¢ ä¾†æºé©—è­‰ - ç™½åå–®æ©Ÿåˆ¶ç¢ºä¿å®‰å…¨æ€§
 * â€¢ æ†‘è­‰æ”¯æŒ - Cookieå’Œèªè­‰é ­éƒ¨çš„è·¨åŸŸå‚³è¼¸
 * â€¢ æ–¹æ³•æ§åˆ¶ - é™åˆ¶å…è¨±çš„HTTPæ–¹æ³•
 *
 * ã€æŠ€è¡“å¯¦ç¾ã€‘
 * â€¢ Dynamic Origin - æ ¹æ“šè«‹æ±‚å‹•æ…‹è¨­ç½®å…è¨±çš„ä¾†æº
 * â€¢ Preflight Cache - é æª¢çµæœç·©å­˜æ¸›å°‘è«‹æ±‚
 * â€¢ Wildcard Support - æ”¯æ´è¬ç”¨å­—ç¬¦å’Œæ­£å‰‡åŒ¹é…
 * â€¢ Environment Aware - æ ¹æ“šç’°å¢ƒè‡ªå‹•èª¿æ•´ç­–ç•¥
 * â€¢ Edge Compatible - æ”¯æ´Edge Runtime
 *
 * ğŸ’¡ Customization Point:
 * æ ¹æ“šæ‚¨çš„åŸŸåä¿®æ”¹ ENVIRONMENT_ORIGINS é…ç½®
 */

import { NextRequest, NextResponse } from 'next/server'

/**
 * CORSé…ç½®æ¥å£
 */
export interface CorsOptions {
  /**
   * å…è¨±çš„ä¾†æº
   * - string[]: ä¾†æºç™½åå–®
   * - '*': å…è¨±æ‰€æœ‰ä¾†æº (ä¸æ¨è–¦ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒ)
   * - (origin: string) => boolean: è‡ªå®šç¾©é©—è­‰å‡½æ•¸
   */
  origins?: string[] | '*' | ((origin: string) => boolean)

  /**
   * å…è¨±çš„HTTPæ–¹æ³•
   * é»˜èª: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']
   */
  methods?: string[]

  /**
   * å…è¨±çš„è«‹æ±‚é ­éƒ¨
   * é»˜èª: ['Content-Type', 'Authorization']
   */
  allowedHeaders?: string[]

  /**
   * æš´éœ²çš„éŸ¿æ‡‰é ­éƒ¨
   * å®¢æˆ¶ç«¯JavaScriptå¯è¨ªå•çš„é ­éƒ¨
   */
  exposedHeaders?: string[]

  /**
   * æ˜¯å¦å…è¨±ç™¼é€æ†‘è­‰ (Cookies, Authorization headers)
   * é»˜èª: true
   */
  credentials?: boolean

  /**
   * é æª¢è«‹æ±‚çš„ç·©å­˜æ™‚é–“ (ç§’)
   * é»˜èª: 86400 (24å°æ™‚)
   */
  maxAge?: number

  /**
   * æ˜¯å¦å…è¨±é æª¢è«‹æ±‚æˆåŠŸè¿”å›
   * é»˜èª: true
   */
  preflightContinue?: boolean

  /**
   * é æª¢è«‹æ±‚çš„HTTPç‹€æ…‹ç¢¼
   * é»˜èª: 204 (No Content)
   */
  optionsSuccessStatus?: number
}

/**
 * é»˜èªCORSé…ç½®
 */
const DEFAULT_CORS_OPTIONS: Required<Omit<CorsOptions, 'origins'>> = {
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: [
    'Content-Type',
    'Authorization',
    'X-Requested-With',
    'X-API-Key',
    'X-Request-ID'
  ],
  exposedHeaders: ['X-Request-ID', 'X-RateLimit-Limit', 'X-RateLimit-Remaining'],
  credentials: true,
  maxAge: 86400, // 24å°æ™‚
  preflightContinue: false,
  optionsSuccessStatus: 204
}

/**
 * ç’°å¢ƒç‰¹å®šçš„CORSé…ç½®
 *
 * ğŸ’¡ Customization Point:
 * ä¿®æ”¹é€™è£¡çš„åŸŸåä»¥åŒ¹é…æ‚¨çš„æ‡‰ç”¨ç¨‹å¼
 */
const ENVIRONMENT_ORIGINS = {
  development: [
    'http://localhost:3000',
    'http://localhost:3001',
    'http://127.0.0.1:3000',
    'http://127.0.0.1:3001'
  ],
  production: [
    // æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›åŸŸå
    'https://{{YOUR_DOMAIN}}',
    'https://www.{{YOUR_DOMAIN}}',
    'https://app.{{YOUR_DOMAIN}}'
  ]
}

/**
 * CORSä¸­é–“ä»¶é¡
 *
 * æä¾›å®Œæ•´çš„CORSè™•ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬é æª¢è«‹æ±‚å’Œå‹•æ…‹é…ç½®ã€‚
 *
 * @example
 * ```typescript
 * const corsHandler = new CorsMiddleware({
 *   origins: ['https://example.com'],
 *   credentials: true
 * })
 *
 * export async function middleware(request: NextRequest) {
 *   return corsHandler.handle(request)
 * }
 * ```
 */
export class CorsMiddleware {
  private options: Required<CorsOptions>

  /**
   * æ§‹é€ å‡½æ•¸
   *
   * @param options CORSé…ç½®é¸é …
   */
  constructor(options: CorsOptions = {}) {
    this.options = {
      ...DEFAULT_CORS_OPTIONS,
      ...options,
      origins: options.origins || this.getDefaultOrigins()
    }
  }

  /**
   * è™•ç†CORSè«‹æ±‚
   *
   * @param request Next.jsè«‹æ±‚å°è±¡
   * @param response å¯é¸çš„éŸ¿æ‡‰å°è±¡ (ç”¨æ–¼ä¿®æ”¹ç¾æœ‰éŸ¿æ‡‰)
   * @returns å¸¶æœ‰CORSé ­éƒ¨çš„éŸ¿æ‡‰
   */
  handle(request: NextRequest, response?: NextResponse): NextResponse {
    const origin = request.headers.get('origin')

    // å¦‚æœæ²’æœ‰originé ­éƒ¨ï¼Œå¯èƒ½æ˜¯åŒæºè«‹æ±‚ï¼Œç›´æ¥è¿”å›
    if (!origin) {
      return response || NextResponse.json(null, { status: 200 })
    }

    // é©—è­‰ä¾†æº
    if (!this.isOriginAllowed(origin)) {
      // ä¾†æºä¸è¢«å…è¨±ï¼Œè¿”å›éŒ¯èª¤æˆ–ç¹¼çºŒä½†ä¸è¨­ç½®CORSé ­éƒ¨
      return response || NextResponse.json(null, { status: 200 })
    }

    // è™•ç†é æª¢è«‹æ±‚ (OPTIONS)
    if (request.method === 'OPTIONS') {
      return this.handlePreflightRequest(request, origin)
    }

    // è™•ç†å¯¦éš›è«‹æ±‚
    return this.handleActualRequest(request, origin, response)
  }

  /**
   * è™•ç†é æª¢è«‹æ±‚ (OPTIONS)
   *
   * @param request è«‹æ±‚å°è±¡
   * @param origin è«‹æ±‚ä¾†æº
   * @returns é æª¢éŸ¿æ‡‰
   */
  private handlePreflightRequest(request: NextRequest, origin: string): NextResponse {
    const corsHeaders = this.buildCorsHeaders(origin, true)
    const response = NextResponse.json(null, {
      status: this.options.optionsSuccessStatus
    })

    // Add CORS headers to response
    corsHeaders.forEach((value, key) => {
      response.headers.set(key, value)
    })

    // æª¢æŸ¥è«‹æ±‚çš„æ–¹æ³•æ˜¯å¦è¢«å…è¨±
    const requestMethod = request.headers.get('access-control-request-method')
    if (requestMethod && !this.options.methods.includes(requestMethod)) {
      return NextResponse.json({ error: 'Method not allowed' }, { status: 405 })
    }

    return response
  }

  /**
   * è™•ç†å¯¦éš›è«‹æ±‚
   *
   * @param request è«‹æ±‚å°è±¡
   * @param origin è«‹æ±‚ä¾†æº
   * @param response ç¾æœ‰éŸ¿æ‡‰ (å¯é¸)
   * @returns å¸¶æœ‰CORSé ­éƒ¨çš„éŸ¿æ‡‰
   */
  private handleActualRequest(
    request: NextRequest,
    origin: string,
    response?: NextResponse
  ): NextResponse {
    // ä½¿ç”¨æä¾›çš„éŸ¿æ‡‰ï¼Œæˆ–å‰µå»ºä¸€å€‹æ–°çš„ç©ºéŸ¿æ‡‰
    const baseResponse = response || NextResponse.json(null, { status: 200 })
    const corsHeaders = this.buildCorsHeaders(origin, false)

    // æ·»åŠ CORSé ­éƒ¨åˆ°éŸ¿æ‡‰
    corsHeaders.forEach((value, key) => {
      baseResponse.headers.set(key, value)
    })

    return baseResponse
  }

  /**
   * æ§‹å»ºCORSé ­éƒ¨
   *
   * @param origin è«‹æ±‚ä¾†æº
   * @param isPreflight æ˜¯å¦ç‚ºé æª¢è«‹æ±‚
   * @returns CORSé ­éƒ¨é›†åˆ
   */
  private buildCorsHeaders(origin: string, isPreflight: boolean): Headers {
    const headers = new Headers()

    // Access-Control-Allow-Origin
    // æ³¨æ„: å¦‚æœcredentialsç‚ºtrueï¼Œä¸èƒ½ä½¿ç”¨ '*'
    if (this.options.credentials) {
      headers.set('Access-Control-Allow-Origin', origin)
      headers.set('Vary', 'Origin')
    } else {
      headers.set('Access-Control-Allow-Origin', '*')
    }

    // Access-Control-Allow-Credentials
    if (this.options.credentials) {
      headers.set('Access-Control-Allow-Credentials', 'true')
    }

    // é æª¢ç‰¹å®šé ­éƒ¨
    if (isPreflight) {
      // Access-Control-Allow-Methods
      headers.set('Access-Control-Allow-Methods', this.options.methods.join(', '))

      // Access-Control-Allow-Headers
      headers.set('Access-Control-Allow-Headers', this.options.allowedHeaders.join(', '))

      // Access-Control-Max-Age
      headers.set('Access-Control-Max-Age', this.options.maxAge.toString())
    }

    // Access-Control-Expose-Headers (å¯¦éš›è«‹æ±‚å’Œé æª¢éƒ½å¯ä»¥è¨­ç½®)
    if (this.options.exposedHeaders.length > 0) {
      headers.set('Access-Control-Expose-Headers', this.options.exposedHeaders.join(', '))
    }

    return headers
  }

  /**
   * é©—è­‰ä¾†æºæ˜¯å¦è¢«å…è¨±
   *
   * @param origin è«‹æ±‚ä¾†æº
   * @returns æ˜¯å¦å…è¨±
   */
  private isOriginAllowed(origin: string): boolean {
    const { origins } = this.options

    // å…è¨±æ‰€æœ‰ä¾†æº
    if (origins === '*') {
      return true
    }

    // å‡½æ•¸é©—è­‰
    if (typeof origins === 'function') {
      return origins(origin)
    }

    // æ•¸çµ„ç™½åå–®
    if (Array.isArray(origins)) {
      return origins.some((allowedOrigin) => {
        // ç²¾ç¢ºåŒ¹é…
        if (allowedOrigin === origin) {
          return true
        }

        // æ”¯æ´è¬ç”¨å­—ç¬¦åŒ¹é… (ä¾‹å¦‚: https://*.example.com)
        if (allowedOrigin.includes('*')) {
          const pattern = allowedOrigin.replace(/\*/g, '.*')
          const regex = new RegExp(`^${pattern}$`)
          return regex.test(origin)
        }

        return false
      })
    }

    return false
  }

  /**
   * ç²å–é»˜èªä¾†æºåˆ—è¡¨
   *
   * æ ¹æ“šç’°å¢ƒè¿”å›é©ç•¶çš„é»˜èªä¾†æºã€‚
   *
   * @returns é»˜èªä¾†æºåˆ—è¡¨
   */
  private getDefaultOrigins(): string[] {
    const env = process.env.NODE_ENV || 'development'

    if (env === 'production') {
      // ç”Ÿç”¢ç’°å¢ƒ: å¾ç’°å¢ƒè®Šæ•¸è®€å–æˆ–ä½¿ç”¨é è¨­å€¼
      const allowedOrigins = process.env.ALLOWED_ORIGINS
      if (allowedOrigins) {
        return allowedOrigins.split(',').map((o) => o.trim())
      }
      return ENVIRONMENT_ORIGINS.production
    } else {
      // é–‹ç™¼ç’°å¢ƒ: å¯¬é¬†è¨­ç½®
      return ENVIRONMENT_ORIGINS.development
    }
  }

  /**
   * æ›´æ–°CORSé…ç½®
   *
   * å‹•æ…‹æ›´æ–°CORSé…ç½®ï¼Œç„¡éœ€é‡æ–°å‰µå»ºå¯¦ä¾‹ã€‚
   *
   * @param options æ–°çš„é…ç½®é¸é …
   */
  updateOptions(options: Partial<CorsOptions>): void {
    this.options = {
      ...this.options,
      ...options
    }
  }
}

/**
 * å‰µå»ºCORSä¸­é–“ä»¶çš„ä¾¿æ·å‡½æ•¸
 *
 * @param options CORSé…ç½®é¸é …
 * @returns CORSä¸­é–“ä»¶å¯¦ä¾‹
 *
 * @example
 * ```typescript
 * import { createCorsMiddleware } from '@/lib/middleware/cors'
 *
 * const cors = createCorsMiddleware({
 *   origins: ['https://example.com', 'https://app.example.com'],
 *   credentials: true,
 *   maxAge: 3600
 * })
 *
 * export async function middleware(request: NextRequest) {
 *   return cors.handle(request)
 * }
 * ```
 */
export function createCorsMiddleware(options?: CorsOptions): CorsMiddleware {
  return new CorsMiddleware(options)
}

/**
 * é»˜èªCORSä¸­é–“ä»¶å¯¦ä¾‹
 *
 * ä½¿ç”¨ç’°å¢ƒæ„ŸçŸ¥çš„é»˜èªé…ç½®ã€‚
 */
export const defaultCorsMiddleware = new CorsMiddleware()

/**
 * ç°¡åŒ–çš„CORSè™•ç†å‡½æ•¸
 *
 * å¿«é€Ÿç‚ºéŸ¿æ‡‰æ·»åŠ CORSé ­éƒ¨çš„å·¥å…·å‡½æ•¸ã€‚
 *
 * @param request è«‹æ±‚å°è±¡
 * @param response éŸ¿æ‡‰å°è±¡
 * @param options CORSé…ç½®é¸é …
 * @returns å¸¶æœ‰CORSé ­éƒ¨çš„éŸ¿æ‡‰
 *
 * @example
 * ```typescript
 * import { applyCors } from '@/lib/middleware/cors'
 *
 * export async function GET(request: NextRequest) {
 *   const data = await fetchData()
 *   const response = NextResponse.json(data)
 *   return applyCors(request, response)
 * }
 * ```
 */
export function applyCors(
  request: NextRequest,
  response: NextResponse,
  options?: CorsOptions
): NextResponse {
  const corsHandler = options ? new CorsMiddleware(options) : defaultCorsMiddleware
  return corsHandler.handle(request, response)
}

/**
 * é è¨­CORSé…ç½®é›†
 *
 * å¸¸ç”¨å ´æ™¯çš„é è¨­é…ç½®ã€‚
 */
export const CorsPresets = {
  /**
   * é–‹ç™¼ç’°å¢ƒé…ç½® (å¯¬é¬†)
   */
  development: {
    origins: '*',
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
    maxAge: 3600
  } as CorsOptions,

  /**
   * ç”Ÿç”¢ç’°å¢ƒé…ç½® (åš´æ ¼)
   */
  production: {
    origins: ENVIRONMENT_ORIGINS.production,
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    maxAge: 86400
  } as CorsOptions,

  /**
   * å…¬é–‹APIé…ç½® (ç„¡æ†‘è­‰)
   */
  publicApi: {
    origins: '*',
    credentials: false,
    methods: ['GET', 'POST', 'OPTIONS'],
    maxAge: 3600
  } as CorsOptions,

  /**
   * åš´æ ¼é…ç½® (å–®ä¸€ä¾†æº)
   */
  strict: (origin: string) =>
    ({
      origins: [origin],
      credentials: true,
      methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
      maxAge: 86400
    }) as CorsOptions
}
