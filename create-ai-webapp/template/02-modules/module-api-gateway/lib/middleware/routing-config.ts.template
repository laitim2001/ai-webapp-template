/**
 * ================================================================
 * AI Web App Template - è·¯ç”±é…ç½® (lib/middleware/routing-config.ts)
 * ================================================================
 *
 * ã€æª”æ¡ˆåŠŸèƒ½ã€‘
 * é›†ä¸­ç®¡ç†æ‰€æœ‰APIè·¯ç”±çš„é…ç½®ï¼ŒåŒ…æ‹¬èªè­‰è¦æ±‚ã€é€ŸçŽ‡é™åˆ¶å’ŒCORSç­–ç•¥ã€‚
 * æä¾›é¡žåž‹å®‰å…¨çš„è·¯ç”±é…ç½®å®šç¾©ï¼Œç¢ºä¿APIç¶²é—œçš„æ­£ç¢ºé‹ä½œã€‚
 *
 * ã€ä¸»è¦è·è²¬ã€‘
 * â€¢ è·¯ç”±å®šç¾© - å®šç¾©æ‰€æœ‰APIç«¯é»žçš„åŒ¹é…è¦å‰‡
 * â€¢ èªè­‰é…ç½® - æŒ‡å®šæ¯å€‹è·¯ç”±çš„èªè­‰è¦æ±‚å’Œæ–¹æ³•
 * â€¢ é€ŸçŽ‡é™åˆ¶ - é…ç½®ç«¯é»žç‰¹å®šçš„é€ŸçŽ‡é™åˆ¶è¦å‰‡
 * â€¢ CORSç­–ç•¥ - å®šç¾©è·¨åŸŸè¨ªå•è¦å‰‡
 * â€¢ ç‰ˆæœ¬æŽ§åˆ¶ - ç®¡ç†APIç‰ˆæœ¬è·¯ç”±
 *
 * ã€æŠ€è¡“å¯¦ç¾ã€‘
 * â€¢ Type-Safe Config - TypeScripté¡žåž‹ä¿è­·
 * â€¢ Priority Routing - å„ªå…ˆç´šæŽ’åºç¢ºä¿æ­£ç¢ºåŒ¹é…
 * â€¢ Flexible Patterns - æ”¯æ´å­—ç¬¦ä¸²ã€æ­£å‰‡å’Œé€šé…ç¬¦
 * â€¢ Environment Aware - æ ¹æ“šç’°å¢ƒèª¿æ•´é…ç½®
 * â€¢ Maintainable - é›†ä¸­ç®¡ç†ä¾¿æ–¼ç¶­è­·
 *
 * ã€ä½¿ç”¨å ´æ™¯ã€‘
 * â€¢ API Gateway - è·¯ç”±è«‹æ±‚åˆ†ç™¼
 * â€¢ èªè­‰æª¢æŸ¥ - æ±ºå®šèªè­‰ç­–ç•¥
 * â€¢ é€ŸçŽ‡é™åˆ¶ - æ‡‰ç”¨ç«¯é»žé™åˆ¶
 * â€¢ CORSè™•ç† - è·¨åŸŸç­–ç•¥æ‡‰ç”¨
 * â€¢ ç‰ˆæœ¬ç®¡ç† - APIç‰ˆæœ¬è·¯ç”±
 *
 * ã€ç›¸é—œæª”æ¡ˆã€‘
 * â€¢ middleware.ts - ä½¿ç”¨æ­¤é…ç½®é€²è¡Œè·¯ç”±åŒ¹é…
 * â€¢ lib/middleware/route-matcher.ts - è·¯ç”±åŒ¹é…é‚è¼¯
 * â€¢ docs/api-gateway-architecture.md - æž¶æ§‹è¨­è¨ˆæ–‡æª”
 *
 * ðŸ’¡ Customization Point:
 * æ ¹æ“šæ‚¨çš„æ¥­å‹™éœ€æ±‚ä¿®æ”¹è·¯ç”±é…ç½®
 */

import { RouteConfig } from './route-matcher'

/**
 * APIè·¯ç”±é…ç½®
 *
 * å®šç¾©æ‰€æœ‰APIç«¯é»žçš„å®Œæ•´é…ç½®ã€‚
 * æŒ‰å„ªå…ˆç´šæŽ’åºï¼šç²¾ç¢ºåŒ¹é… > æ­£å‰‡è¡¨é”å¼ > é€šé…ç¬¦
 *
 * ðŸ’¡ Customization Point:
 * æ·»åŠ æ‚¨çš„æ¥­å‹™è·¯ç”±é…ç½®
 */
export const routeConfigs: RouteConfig[] = [
  // ================================================================
  // å…¬é–‹ç«¯é»ž (ç„¡èªè­‰è¦æ±‚)
  // ================================================================

  /**
   * å¥åº·æª¢æŸ¥ç«¯é»ž
   * ç”¨æ–¼è² è¼‰å‡è¡¡å™¨å’Œç›£æŽ§ç³»çµ±
   */
  {
    name: 'health-check',
    pattern: /^\/api\/health$/,
    priority: 100,
    auth: { required: false, methods: [] },
    rateLimit: {
      windowMs: 60000, // 1åˆ†é˜
      maxRequests: 100
    }
  },

  /**
   * APIç‰ˆæœ¬ä¿¡æ¯
   */
  {
    name: 'version-info',
    pattern: /^\/api\/version$/,
    priority: 100,
    auth: { required: false, methods: [] },
    rateLimit: {
      windowMs: 60000,
      maxRequests: 60
    }
  },

  // ================================================================
  // èªè­‰ç›¸é—œç«¯é»ž (ç‰¹æ®Šè™•ç†)
  // ================================================================

  /**
   * ç”¨æˆ¶ç™»å…¥
   * åš´æ ¼é€ŸçŽ‡é™åˆ¶é˜²æ­¢æš´åŠ›ç ´è§£
   */
  {
    name: 'auth-login',
    pattern: /^\/api\/auth\/login$/,
    priority: 90,
    auth: { required: false, methods: [] },
    rateLimit: {
      windowMs: 900000, // 15åˆ†é˜
      maxRequests: 5
    }
  },

  /**
   * ç”¨æˆ¶è¨»å†Š
   */
  {
    name: 'auth-register',
    pattern: /^\/api\/auth\/register$/,
    priority: 90,
    auth: { required: false, methods: [] },
    rateLimit: {
      windowMs: 900000, // 15åˆ†é˜
      maxRequests: 3
    }
  },

  /**
   * Tokenåˆ·æ–°
   */
  {
    name: 'auth-refresh',
    pattern: /^\/api\/auth\/refresh$/,
    priority: 90,
    auth: { required: false, methods: [] },
    rateLimit: {
      windowMs: 60000, // 1åˆ†é˜
      maxRequests: 10
    }
  },

  /**
   * ç”¨æˆ¶ç™»å‡º
   */
  {
    name: 'auth-logout',
    pattern: /^\/api\/auth\/logout$/,
    priority: 90,
    auth: { required: true, methods: ['jwt'] },
    rateLimit: {
      windowMs: 60000,
      maxRequests: 10
    }
  },

  // ================================================================
  // Azure AD SSOç«¯é»ž
  // ================================================================

  /**
   * Azure ADç™»å…¥
   */
  {
    name: 'azure-ad-login',
    pattern: /^\/api\/auth\/azure-ad\/login$/,
    priority: 85,
    auth: { required: false, methods: [] },
    rateLimit: {
      windowMs: 300000, // 5åˆ†é˜
      maxRequests: 10
    }
  },

  /**
   * Azure ADå›žèª¿
   */
  {
    name: 'azure-ad-callback',
    pattern: /^\/api\/auth\/azure-ad\/callback$/,
    priority: 85,
    auth: { required: false, methods: [] },
    rateLimit: {
      windowMs: 300000,
      maxRequests: 10
    }
  },

  /**
   * Azure ADç™»å‡º
   */
  {
    name: 'azure-ad-logout',
    pattern: /^\/api\/auth\/azure-ad\/logout$/,
    priority: 85,
    auth: { required: true, methods: ['jwt', 'azureAD'] },
    rateLimit: {
      windowMs: 60000,
      maxRequests: 10
    }
  },

  // ================================================================
  // ç®¡ç†å“¡API (éœ€è¦ADMINè§’è‰²)
  // ================================================================

  /**
   * ç”¨æˆ¶ç®¡ç†API
   */
  {
    name: 'admin-users',
    pattern: /^\/api\/admin\/users/,
    priority: 80,
    auth: {
      required: true,
      methods: ['jwt', 'azureAD'],
      roles: ['ADMIN']
    },
    rateLimit: {
      windowMs: 60000,
      maxRequests: 100
    }
  },

  /**
   * ç³»çµ±é…ç½®API
   */
  {
    name: 'admin-config',
    pattern: /^\/api\/admin\/config/,
    priority: 80,
    auth: {
      required: true,
      methods: ['jwt', 'azureAD'],
      roles: ['ADMIN']
    },
    rateLimit: {
      windowMs: 60000,
      maxRequests: 60
    }
  },

  /**
   * API Keyç®¡ç†
   */
  {
    name: 'admin-api-keys',
    pattern: /^\/api\/admin\/api-keys/,
    priority: 80,
    auth: {
      required: true,
      methods: ['jwt', 'azureAD'],
      roles: ['ADMIN']
    },
    rateLimit: {
      windowMs: 60000,
      maxRequests: 30
    }
  },

  // ================================================================
  // v2 APIç«¯é»žç¤ºä¾‹ (æ–°ç‰ˆæœ¬ï¼Œå¢žå¼·åŠŸèƒ½)
  // ================================================================

  /**
   * ðŸ’¡ ç¤ºä¾‹: v2 APIç«¯é»ž
   * æ·»åŠ æ‚¨çš„ v2 ç‰ˆæœ¬æ¥­å‹™è·¯ç”±
   */
  {
    name: 'v2-example',
    pattern: /^\/api\/v2\/example/,
    version: 'v2',
    priority: 70,
    auth: {
      required: true,
      methods: ['jwt', 'azureAD', 'apiKey']
    },
    rateLimit: {
      windowMs: 60000,
      maxRequests: 100
    }
  },

  // ================================================================
  // v1 APIç«¯é»žç¤ºä¾‹ (èˆŠç‰ˆæœ¬ï¼Œå‘å¾Œå…¼å®¹)
  // ================================================================

  /**
   * ðŸ’¡ ç¤ºä¾‹: v1 APIç«¯é»ž
   * æ·»åŠ æ‚¨çš„ v1 ç‰ˆæœ¬æ¥­å‹™è·¯ç”±
   */
  {
    name: 'v1-example',
    pattern: /^\/api\/v1\/example/,
    version: 'v1',
    priority: 60,
    auth: {
      required: true,
      methods: ['jwt']
    },
    rateLimit: {
      windowMs: 60000,
      maxRequests: 60
    }
  },

  // ================================================================
  // é€šç”¨APIç«¯é»žç¤ºä¾‹ (ç„¡ç‰ˆæœ¬æ¨™è­˜)
  // ================================================================

  /**
   * ðŸ’¡ ç¤ºä¾‹: ç”¨æˆ¶é…ç½®API
   * æ·»åŠ æ‚¨çš„é€šç”¨æ¥­å‹™è·¯ç”±
   */
  {
    name: 'user-profile',
    pattern: /^\/api\/user\/profile/,
    priority: 40,
    auth: {
      required: true,
      methods: ['jwt', 'azureAD']
    },
    rateLimit: {
      windowMs: 60000,
      maxRequests: 60
    }
  },

  /**
   * ðŸ’¡ ç¤ºä¾‹: æ–‡ä»¶ä¸Šå‚³API
   */
  {
    name: 'upload',
    pattern: /^\/api\/upload/,
    priority: 40,
    auth: {
      required: true,
      methods: ['jwt', 'azureAD']
    },
    rateLimit: {
      windowMs: 60000,
      maxRequests: 10
    }
  },

  // ================================================================
  // å›žé€€è·¯ç”± (æœ€ä½Žå„ªå…ˆç´š)
  // ================================================================

  /**
   * æ‰€æœ‰å…¶ä»–APIç«¯é»ž (éœ€è¦èªè­‰)
   */
  {
    name: 'api-default',
    pattern: /^\/api\//,
    priority: 0,
    auth: {
      required: true,
      methods: ['jwt', 'azureAD', 'apiKey']
    },
    rateLimit: {
      windowMs: 60000,
      maxRequests: 60
    }
  }
]

/**
 * ç²å–ç’°å¢ƒç‰¹å®šçš„è·¯ç”±é…ç½®
 *
 * @returns æ ¹æ“šç•¶å‰ç’°å¢ƒèª¿æ•´çš„è·¯ç”±é…ç½®
 */
export function getRouteConfigs(): RouteConfig[] {
  const env = process.env.NODE_ENV || 'development'

  if (env === 'development') {
    // é–‹ç™¼ç’°å¢ƒï¼šæ”¾å¯¬é€ŸçŽ‡é™åˆ¶ï¼Œå•Ÿç”¨æ›´å¤šèª¿è©¦åŠŸèƒ½
    return routeConfigs.map((config) => ({
      ...config,
      rateLimit: config.rateLimit
        ? {
            ...config.rateLimit,
            maxRequests: config.rateLimit.maxRequests * 10 // 10å€é™åˆ¶
          }
        : undefined
    }))
  }

  return routeConfigs
}

/**
 * æ ¹æ“šè·¯ç”±åç¨±æŸ¥æ‰¾é…ç½®
 *
 * @param name è·¯ç”±åç¨±
 * @returns è·¯ç”±é…ç½®æˆ–undefined
 */
export function getRouteByName(name: string): RouteConfig | undefined {
  return routeConfigs.find((config) => config.name === name)
}

/**
 * ç²å–æ‰€æœ‰éœ€è¦ç‰¹å®šè§’è‰²çš„è·¯ç”±
 *
 * @param role è§’è‰²åç¨±
 * @returns éœ€è¦è©²è§’è‰²çš„è·¯ç”±é…ç½®åˆ—è¡¨
 */
export function getRoutesByRole(role: string): RouteConfig[] {
  return routeConfigs.filter((config) => config.auth.roles?.includes(role))
}

/**
 * ç²å–æ‰€æœ‰å…¬é–‹è·¯ç”± (ç„¡èªè­‰è¦æ±‚)
 *
 * @returns å…¬é–‹è·¯ç”±é…ç½®åˆ—è¡¨
 */
export function getPublicRoutes(): RouteConfig[] {
  return routeConfigs.filter((config) => !config.auth.required)
}

/**
 * ç²å–æŒ‡å®šç‰ˆæœ¬çš„æ‰€æœ‰è·¯ç”±
 *
 * @param version APIç‰ˆæœ¬
 * @returns è©²ç‰ˆæœ¬çš„è·¯ç”±é…ç½®åˆ—è¡¨
 */
export function getRoutesByVersion(version: 'v1' | 'v2'): RouteConfig[] {
  return routeConfigs.filter((config) => config.version === version)
}
