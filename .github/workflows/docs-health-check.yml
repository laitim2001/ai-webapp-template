# æ–‡æª”å¥åº·æª¢æŸ¥å·¥ä½œæµç¨‹
# Documentation Health Check Workflow

name: Documentation Health Check

# è§¸ç™¼æ¢ä»¶
on:
  # æ¯é€±ä¸€æ—©ä¸Š 9:00 (UTC) è‡ªå‹•åŸ·è¡Œ
  schedule:
    - cron: '0 9 * * 1'

  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

  # PR æ¶‰åŠæ–‡æª”è®Šæ›´æ™‚è§¸ç™¼
  pull_request:
    paths:
      - '**.md'
      - 'Docs/**'
      - 'scripts/check-docs-health.js'

  # Push åˆ° main åˆ†æ”¯ä¸”æ¶‰åŠæ–‡æª”æ™‚è§¸ç™¼
  push:
    branches:
      - main
    paths:
      - '**.md'
      - 'Docs/**'

jobs:
  check-docs:
    name: æª¢æŸ¥æ–‡æª”å¥åº·åº¦
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout ä»£ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²ä»¥æª¢æŸ¥æ–‡ä»¶ä¿®æ”¹æ™‚é–“

      # 2. è¨­ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3. åŸ·è¡Œæ–‡æª”å¥åº·æª¢æŸ¥
      - name: Run documentation health check
        id: health-check
        run: |
          node scripts/check-docs-health.js
          echo "report_generated=true" >> $GITHUB_OUTPUT

      # 4. ä¸Šå‚³å¥åº·å ±å‘Šç‚º artifact
      - name: Upload health report
        if: steps.health-check.outputs.report_generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: doc-health-report
          path: Docs/doc-health-report-*.md
          retention-days: 30

      # 5. åœ¨ PR ä¸­è©•è«–å ±å‘Šæ‘˜è¦ (åƒ… PR è§¸ç™¼æ™‚)
      - name: Comment PR with report summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportFiles = fs.readdirSync('Docs')
              .filter(f => f.startsWith('doc-health-report-'))
              .sort()
              .reverse();

            if (reportFiles.length > 0) {
              const reportPath = `Docs/${reportFiles[0]}`;
              const reportContent = fs.readFileSync(reportPath, 'utf-8');

              // æå–æ‘˜è¦éƒ¨åˆ†ï¼ˆå‰100è¡Œï¼‰
              const summary = reportContent.split('\n').slice(0, 100).join('\n');

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ“Š æ–‡æª”å¥åº·æª¢æŸ¥å ±å‘Š\n\n${summary}\n\nå®Œæ•´å ±å‘Šè«‹æŸ¥çœ‹ Artifactsã€‚`
              });
            }

      # 6. æª¢æŸ¥æ˜¯å¦æœ‰åš´é‡å•é¡Œ
      - name: Check for critical issues
        run: |
          REPORT_FILE=$(ls -t Docs/doc-health-report-*.md | head -1)

          if [ -z "$REPORT_FILE" ]; then
            echo "::warning::ç„¡æ³•æ‰¾åˆ°å¥åº·å ±å‘Šæ–‡ä»¶"
            exit 0
          fi

          # æª¢æŸ¥æ˜¯å¦æœ‰ç¼ºå¤±çš„æ ¸å¿ƒæ–‡æª”
          if grep -q "ç¼ºå¤±çš„æ ¸å¿ƒæ–‡æª”" "$REPORT_FILE"; then
            echo "::error::ç™¼ç¾ç¼ºå¤±çš„æ ¸å¿ƒæ–‡æª”ï¼"
            exit 1
          fi

          # æª¢æŸ¥å¥åº·åº¦è©•åˆ†
          SCORE=$(grep "æ•´é«”å¥åº·åº¦" "$REPORT_FILE" | grep -oP '\d+\.\d+' | head -1)

          if [ ! -z "$SCORE" ]; then
            echo "æ–‡æª”å¥åº·åº¦: $SCORE%"

            if (( $(echo "$SCORE < 70" | bc -l) )); then
              echo "::error::æ–‡æª”å¥åº·åº¦éä½ ($SCORE%)ï¼Œéœ€è¦ç«‹å³æ”¹é€²ï¼"
              exit 1
            elif (( $(echo "$SCORE < 90" | bc -l) )); then
              echo "::warning::æ–‡æª”å¥åº·åº¦ $SCORE%ï¼Œå»ºè­°æ”¹é€²"
            else
              echo "::notice::æ–‡æª”å¥åº·åº¦è‰¯å¥½ ($SCORE%) âœ…"
            fi
          fi

      # 7. è‡ªå‹•å‰µå»º Issue (å¦‚æœå¥åº·åº¦ä½æ–¼ 70%)
      - name: Create issue for low health score
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportFiles = fs.readdirSync('Docs')
              .filter(f => f.startsWith('doc-health-report-'))
              .sort()
              .reverse();

            if (reportFiles.length > 0) {
              const reportPath = `Docs/${reportFiles[0]}`;
              const reportContent = fs.readFileSync(reportPath, 'utf-8');

              // æå–å»ºè­°è¡Œå‹•éƒ¨åˆ†
              const actionsSection = reportContent.split('## ğŸ“‹ å»ºè­°è¡Œå‹•')[1] || 'è«‹æŸ¥çœ‹å®Œæ•´å ±å‘Š';

              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ¥ æ–‡æª”å¥åº·åº¦æª¢æŸ¥å¤±æ•— - éœ€è¦ç«‹å³è™•ç†',
                body: `## æ–‡æª”å¥åº·æª¢æŸ¥å¤±æ•—\n\n**æª¢æ¸¬æ™‚é–“**: ${new Date().toISOString()}\n\n## å»ºè­°è¡Œå‹•\n\n${actionsSection}\n\nå®Œæ•´å ±å‘Šè«‹æŸ¥çœ‹ [Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                labels: ['documentation', 'maintenance', 'priority-high']
              });
            }
